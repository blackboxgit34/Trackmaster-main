@{
    ViewBag.Title = "AddTrip";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*<link href="~/Content/css/multi-select.css" rel="stylesheet" />
<link href="~/Content/select2/select2.css" rel="stylesheet" />
<link href="~/Content/select2/select2-bootstrap.css" rel="stylesheet" />
<script src="~/Content/select2/select2.min.js"></script>*@
<script src="~/Content/Alertify/sweetalert.min.js"></script>
<link href="~/Content/Alertify/sweetalert.css" rel="stylesheet" />
<style>
    .nav {
        margin-left: 0;
        margin-bottom: 4px !important;
    }


    .select2-container{
    z-index:1000 !important;
}
    /*.js-example-basic-multiple.form-control {
     height: 10px !important;
}
.select2-selection__rendered {
  line-height: 20px !important;
}*/

    /*.select2-selection {
  height: 34px !important;
}*/
    #directions-panel {
        /*margin-top: 10px;
        background-color: #8e9d13;*/
        color: #315492;
        /*padding: 10px;
        overflow: auto;*/
       height: 174px;
    }
</style>
<div id="Fade" class="w3-container city w3-animate-zoom">
    <form onclick="fg();">
    <div class="row-fluid">

        <div class="row-fluid">
            <!--Heading part-->
            <div class="widget-body" style="border: 0">
                <div class="row-fluid">
                    <div class="widget span12">
                        <div class="widget-header">
                            <i class="fa fa-truck"></i>
                            <h5>Add Trip</h5>
                               <div class="pull-right" style="width: 200px;">
                                <button class="pull-right btn btn-green btn-small" style="margin-top: 5.5%; margin-right: 10%;"  href="#" id="btnaddroute">Manage Existing Trip </button> 
                           </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Route Form-->
              
            <div class="col-md-12" style="padding: 0px;">
                 
               
             
                <div class="col-md-4" style="padding: 0px;">
                          
                     
                   
                    <div class="row-fluid">
                    
                        <div class="widget-body" style="border: 0">
                         
                            <div class="row-fluid">

                                            
                                       <div class="tab-pane active" id="1">
                                <div class="widget span12">
                                    <div class="widget-body  " style="background: #fff; overflow-x: auto">
                                        <div id="DivVehcleCounter">
                                            <div class="box-content padded">
                                                <form data-toggle="validator" role="form">
                                                      <button type="button" class="btn btn-default btn-small pull-right" id="btntrip" style="display:none;">Trip Details<img src="~/img/flags/3723_-_Route_II-512%20(1).png" style="height:16px"/></button>
                                                    <div class="col-md-12">
                                                        <div class="form-group ">
                                                            <span>
                                                                <label for="inputName" class="control-label"><b>Select Vehicle</b></label></span>
                                                            <select class="form-control select2" id="ddlVehicleList" multiple style="height: 70%;"></select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                            
                                                      @*  <div class="col-md-6">*@
                                                            <div class="form-group ">
                                                                <span>
                                                                    <label for="inputName" class="control-label"><b>Trip Name</b></label></span>

                                                                <span style="color: indianred" class="hidden" id="valRouteName"><i class=" fa fa-exclamation-triangle"></i>Please enter Trip Name.</span>

                                                                <input type="text" class="pull-right" id="txtRouteName" placeholder="Enter Trip name" />
                                                            </div>
                                                  
                                                            <div class="form-group" >
                                                                <label for="inputName" class="control-label"><b>Trip Type</b></label>
                                                                <select id="triptype">
                                                                    <option value="1">Single Trip</option>
                                                                    <option value="2">Round Trip</option>
                                                                </select>
                                                            </div>
                                                  


                                                    </div>
                                                    <div class="col-md-12">
                                              
                                                            <div class="form-group ">
                                                        
                                         

                                                                         <span><b>Choose Start Point(POI)</b></span>
                                                                
                                                                <span style="color: indianred" class="hidden" id="valStartLocation"><i class="fa fa-exclamation-triangle"></i>Insert Start Location.</span>

                                                                <select class="form-control select2" id="ddlStartLocationPOI"></select>

           





                                                            </div>
                                                   

                                                    </div>
                                                           
                                               
                                                              <div class="col-md-12">
                                            
                                                          <div class="form-group">
                                                                <button class="btn btn-default btn-small pull-right" id="btnaddpoi">Add POI <img src="../img/flags/icon-png.png" style="height: 16px;"/></button>
                                                     
                                                              </div>
                                                                  </div>
                                                                        <div class="col-md-12">
                                            
                                                          <div class="form-group">

                                                                      <span><b>Choose End Point(POI)</b></span>
                          
                                                                <span style="color: indianred" class="hidden" id="valEndLocation">
                                                                    <i class=" fa fa-exclamation-triangle"></i>Insert End Location

                                                                </span>
                                                                <select class="form-control select2" id="ddlEndLocationPOI"></select>





                                                       
                                                            </div>
                                                        </div>
                                           
                                              <div class="col-md-12 padded" >
                                                        <div class="form-group ">
                                                            <span> <label for="inputName" class="control-label" id="hidediv" style="display:none;">Add More Points(POI)</label></span>
                                                          
                                                            <div id="hidediv2" style="display:none;">
                                                                  <select class="form-control select2"  id="ddlMoreLocationsPOI"  multiple ></select>
                                                            </div>
                                                          
                                                        </div>

                                                    </div>

                                                    

                                                    <div class="col-md-12" style="display:none">
                                                        <div class="form-group padded">
                                                            <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
                                                                <i class=" fa fa-calendar"></i>
                                                                &nbsp;<span></span><b class="caret"></b>

                                                            </div>

                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <button type="button" onclick="submitUpdateSettings();" class="btn btn-default pull-right" style="margin: 2%;background-color:#cccccc;">Submit <img src="~/img/flags/submit.png" style="height:11px;"/></button>
                                                   

                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>


                   
                </div>
                                </div>
                                       
                                   


                                <div class="widget span12" style="position: absolute;left: 430px; top: 0px;z-index: 99;">
                                    
                                    <div class="widget-body  " style="background:#fff; overflow-x: auto; height: 540px;width: 301px;display:none" id="hidedivnew">
                                        <div id="DivVehcledetails">
                                            <div class="box-content padded">
                                                <form data-toggle="validator" role="form">
                                                     
                                                             <ul class="nav nav-tabs" >
                                      <li class="active">
                                          
                                      <a href="#1" data-toggle="tab" style="    background-color: #bababa;height: 48px;width: 429px;top: -15px;left: -118px;padding-top: 7px;"><span style="color:white;margin-left:106px;">Trip Details</span> <img id="imgclose"  src="../images/battery/delete.png"   style="height: 11px;width: 11px;margin-left: 189px;margin-top: -10px;"/>   </a>
                                       
                                      </li>
                                                                 
                                       <span><label for="inputName" class="control-label"><b>Trip Distance and Type</b></label></span>
                                      </ul>
                                            
                                       

                                                    <div class="col-md-12">
                                                    

                                                        <div class="col-md-6">
                                                            <label for="inputName" class="control-label DatePicker"><b> Time</b></label>

                                                            <span style="color: indianred" class="hidden" id="valTimeRange"><i class=" fa fa-exclamation-triangle"></i>Select Date range.</span>
                                                            <div class="input-group">
                                                                <div class="input-group date" data-provide="datepicker">
                                                                    <input type="text" id="txtETT" style="text-align: center; font-weight: bold;" class="form-control " />
                                                                    <div class="input-group-addon">
                                                                        <span class="">Hours</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                         
                                                        </div>

                                                        <div class="col-md-6" style="background-color: transparent !important;">

                                                            <div class="form-group ">
                                                                <label for="inputName" class="control-label"><b> Distance</b></label>
                                                                <div class="input-group">
                                                                    <div class="input-group date" data-provide="datepicker">
                                                                        @*<input id="txtGoogleDistance" type="number" style="text-align: center; font-weight: bold;" class="form-control" >*@


                                                                        <input id="txtManualDistance" type="number" style="text-align: center; font-weight: bold;" class="form-control ">
                                                                        <div class="input-group-addon">
                                                                            <span class="">KM</span>
                                                                        </div>
                                                                    </div>
                                                                    <input type="hidden" id="custId" name="custId" />
                                                                    <input type="hidden" id="bbid" name="bbid" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                     
                                                    </div>
                                                                          <ul class="nav nav-tabs" >
                                      <li class="active">
                                          
                               
                                      </li>
                                       <span>
                                                                <label for="inputName" class="control-label"><b>Driving Time</b></label></span>
                                      </ul>
                                                    <img src="../img/flags/routecar.png" /><h4> <p id="test1" style="color:#315492;margin-left: 50PX;MARGIN-TOP: -35px;">This is a paragraph.</p></h4>
                                              
                                                   
                  
                                    <div id="directions-panel" style="display: none;"></div>
                
         
                                                </form>
                                            </div>
                                        </div>
                                    </div>


                   
                </div>
                                <div class="widget span12" style="position: absolute;left: 995px; top:41px;z-index: 99;">
                                    
                                    <div class="widget-body  " style="background:#f5f5f5; overflow-x: auto; height:180px;width: 301px;display:none;" id="hidedivnewd">
                                        <div id="Divpoidetails">
                                            <div class="box-content padded">
                                                <form data-toggle="validator" role="form">
                                                     
                                                             <ul class="nav nav-tabs" >
                                     
                                                                 
                                       <span><label for="inputName" class="control-label"><b>Add POI </b></label></span>
                                      </ul>
                                            
                                       

                                                    <div class="col-md-12">

                                                        <div class="form-group">
                                                       
                              <input type="text" class="form-control" id="addressPlace" placeholder="Search location..." style="margin-left: 20px;"><img src="../img/flags/icon-png.png" style="    height: 38px;margin-left:-26px;margin-top: -71px;"/>

                                                
</div>
                                                
                                                     
                                                    </div>
                                  
                                          
                                  <div class="col-md-12">
                                                        <button type="button" onclick="Close();" class="btn btn-default pull-right" style="margin:-6%;background-color:#cccccc;">Close</button>
                   

                                                    </div>
                                     
                                              
                                                   
               

         
                                                </form>
                                            </div>
                                        </div>
                                    </div>


                   
                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8" style="padding: 0px;">
                    <div class="box_a">
                        <div class="box_a_content">
                            <div id="map_canvas" style="width: 100%; height: 538px !important; position: inherit;"></div>
                               <div id="dvDistance">
                </div>
                
                        </div>
                    </div>
                </div>
            </div>

    

            <!--End of Route Form-->
        </div>
    </div>
        </form>
</div>
<div id="PasswordDialog" title="Basic dialog">
</div>
@section scripts{
    <script src="~/Scripts/app/common.js"></script>
    <script src="~/Content/js/APIURL.js"></script>
       <script type="text/javascript" src="@Url.Content("~/scripts/app/Security.js?")"@DateTime.Now.Ticks></script>
    <!--for saving route detail-->
    <script>
        $(document).ready(function () {
            $(".select2").select2({
                //  placeholder: "select Vehicles.",
            });
            //simple lis to select2
            $("#ddlVehicleList").select2({
                placeholder: "assign vehicles",
            });
            $("#ddlVehicleListN").select2({
                placeholder: "assign vehicles",
            });
            //end of simple list to select2

            ajaxForPopUp();
            appendVehicleDDL();
            var baseurl1 = apiBase.apiurl;
            // var baseurl1 = '@System.Configuration.ConfigurationManager.AppSettings["apibaseurl"]';
            //method for appending poi list
            function ajaxForPopUp() {
                var baseurl = apiBase.apiurl;

                //var baseurl = '@System.Configuration.ConfigurationManager.AppSettings["apibaseurl"]';
                $.ajax({
                    url: baseurl + 'CommonApi/GetPOI?custid=' + $custid,
                    type: "get",
                    async: false,
                    success: function (data) {
                        debugger;
                        $('#ddlStartLocationPOI').append($('<option disabled selected></option>').val("").html("Select POI"));
                        $('#ddlEndLocationPOI').append($('<option disabled selected></option>').val("").html("Select POI"));
                        $.each(data, function (i, item) {
                            $('#ddlStartLocationPOI').append($('<option></option>').val(item.id).html(item.details));
                            $('#ddlEndLocationPOI').append($('<option></option>').val(item.id).html(item.details));
                            $('#ddlMoreLocationsPOI').append($('<option></option>').val(item.id).html(item.details));

                        });
                    },
                    error: function () {
                        connectionError();
                    }
                });
            }

            function appendVehicleDDL() {
                $.ajax({
                    dataType: "json",
                    type: "GET",
                    contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                    //url: apiBase.apiurl + "AdminAPI/GetManageRoute",
                    url: apiBase.apiurl + "AdminAPI/GetVehicles",

                    data: { custId: $custid },
                    success: function (result) {
                        debugger;
                        var data = result;

                        if (data.length > 0) {
                            $.each(data, function (j, item) {
                                $('#ddlVehicleList').append($('<option></option>').val(item.Value).html(item.Text));
                             
                            });
                        }

                    }
                });
            }


            //end of method for appending poi list
        });



        function Close() {
            $("#hidedivnewd").css('display', 'none');
        }


        function submitUpdateSettings() {

            debugger;
            var custId = $custid;
            //  var bbid = $("#bbid").val();
            //  var bbidList = $("#vehicleslist").val().toString();
            var startLocation = $("#ddlStartLocationPOI").val();
            var endLocation = $("#ddlEndLocationPOI").val();
            var morePoiIds = $("#ddlMoreLocationsPOI").val();
            var morePoiIdsList = morePoiIds.toString();
            var triptypeID = $("#triptype").val();
            // var triptypeID = 1;
            var routeName = $("#txtRouteName").val();
            var ettTime = $("#txtETT").val();

            //getting bbbidList
            var bbidArray = $("#ddlVehicleList").val();
            var bbidList = bbidArray.toString();
            var distanceKm;
            distanceKm = $("#txtManualDistance").val();
            //getting datetime
            var startDateTime = $beginDate;
            var endDateTime = $endDate;
            if (!startLocation || !endLocation || !routeName) {
                $("#valStartLocation").removeClass("hidden");
                $("#valEndLocation").removeClass("hidden");
                $("#valRouteName").removeClass("hidden");

                //$("#valavgSpeedRange").removeClass("hidden");
                return false;
            }
            else {
                $("#valStartLocation").addClass("hidden");
                $("#valEndLocation").addClass("hidden");
                // $("#valmaxConDriTime").addClass("hidden");
                $("#valvehicleslist").addClass("hidden");
                $("#valRouteName").addClass("hidden");
            }

            var Routetype = 2;
    $.blockUI({ message: '<h1><img src="../../Content/Trackmaster_files/loader.gif" /> </h1><br><h3>Just a moment...</h3>' });
    // $('#myModal').modal('toggle');
    // var baseurl = '@System.Configuration.ConfigurationManager.AppSettings["apibaseurl"]';
    var baseurl = apiBase.apiurl;
    var url = baseurl + "adminapi/UpdateTripSettings";
    $.ajax({
        url: url,
        dataType: "json",
        type: "GET",
        contentType: 'application/x-www-form-urlencoded; charset=utf-8',
        data: { SLocation: startLocation, ELocation: endLocation, custId: custId, distance: distanceKm, triptypeID: triptypeID, routeName: routeName, ettTime: ettTime, bbidList: bbidList, poiIds: morePoiIdsList, startDateTime: startDateTime, endDateTime: endDateTime, Routetype: Routetype },
        // async: false,
        success: function (data) {
            $.unblockUI();
            toastr.success('Trip Created successfully!');
            // window.location.reload(true);
        },
        error: function (err) {
            $.unblockUI();
            toastr.warning('something went wrong!');
        }

    });
            return false;
        }




        $("#btnaddroute").click(function () {
            window.location.href = "@Url.Action("ManageTrip","settings")";
        });
    </script>

       <!--for ADDING POI DIRECTLY-->
<script type="text/javascript" src="~/js/common.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCITh4LYqVNyaJ_YDiYgRxv29dhPJnU-5o&libraries=places" language="javascript" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {

            geocoder = new google.maps.Geocoder();
            var lat = GET('lat');
            var lng = GET('longi');
            if (lat == "") {
                lat = '30.724149';
                lng = '76.76';
            }
            var myLatlng = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
            var myOptions = {
                zoom: 12,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

            var pinImage = new google.maps.MarkerImage("http://www.googlemapsmarkers.com/v1/009900/");
            marker = new google.maps.Marker({
                position: myLatlng,
                icon: pinImage,
                map: map,
                title: "Add location",
                draggable: true

            });
            //for clearing when user search by place
            markersCodeAddress.push(marker);

            // info window
            infowindow = new google.maps.InfoWindow({
                content: html
            });
            google.maps.event.addListener(marker, "click", function () {
                infowindow.open(map, marker);
            });
        });
        var map;
        var html = "<table cellpadding='5' cellspacing='5' style='width:450px;'>" +
                 "<tr><td>POI Name:</td> <td><input type='text' class='text' style='width:250px;' id='name'/> </td> </tr>" +
                 "<tr><td></td><td><input type='button' value='Save' onclick='saveData()'/></td></tr><tr><td><span id='message'></span></td></tr>";
        var marker;
        var infowindow;
        var geocoder;

        // save data
        function saveData() {
            var message = "";
            debugger;
            var lat = GET('lat');
            var lng = GET('longi');
            var name = decodeURIComponent(document.getElementById("name").value);
            if (name == '') {

                alert('Please enter location');
                return false;
            }
            else {
                var latlng = marker.getPosition();
                lat = latlng.lat();
                lng = latlng.lng();
                var MyUrl = apiBase.apiurl + "CommonApi/AddPOIntrest";
                $.ajax({

                    url: MyUrl,
                    type: "GET",
                    data: { custid: $custid, lat: lat, longi: lng, location: name },


                    //contentType: 'application/json',

                    success: function (data) {


                        if (data == "Location Exists") {
                            message = "Location Already Exist!";
                            $("#message").html("Location Already Exist!");
                            $("#message").css("color", "red");
                        }
                        else {
                            if (data == false) {
                                message = "Your POI limit is over. If you want to add new POIs than please contact Our Market Executives.";
                                $("#message").html("Your POI limit is over. If you want to add new POIs than please contact Our Market Executives.");
                                $("#message").css("color", "red");
                            }
                            else {
                            }
                            message = "Location Saved Succesfully!";
                            $("#message").html("Location Saved Succesfully!");
                            $("#message").css("color", "green");
                            $("#name").val("");
                        }
                        alert(message);
                        location.reload();
                    }
                });
            }


        }

        // download URL

        // do nothing
        function doNothing() { }
    </script>
    <script>

        var endLocationLat;
        var endLocationLong;

        google.maps.event.addDomListener(window, 'load', initialize1);
        function initialize1() {
            var input = document.getElementById('addressPlace');
            var options = {
                componentRestrictions: { country: 'IN' }
            };
            var autocomplete = new google.maps.places.Autocomplete(input, options);
            autocomplete.addListener('place_changed', function () {

                var place = autocomplete.getPlace();
                // place variable will have all the information you are looking for.
                console.log(place.geometry['location'].lat());
                endLocationLat = place.geometry['location'].lat();
                endLocationLong = place.geometry['location'].lng();

                console.log(place.geometry['location'].lng());
                codeAddress();
            });
        }


        var markersCodeAddress = [];

        function codeAddress() {

            var address = document.getElementById('addressPlace').value;
            geocoder.geocode({ 'address': address }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                    $('#LatLng').val(results[0].geometry.location);
                    var pinImage = new google.maps.MarkerImage("http://www.googlemapsmarkers.com/v1/009900/");
                    clearLocations();
                    marker = new google.maps.Marker({
                        // map: map,
                        position: results[0].geometry.location,
                        icon: pinImage,
                        map: map,
                        title: "Add location",
                        draggable: true
                    });
                    markersCodeAddress.push(marker);

                    // info window
                    infowindow = new google.maps.InfoWindow({
                        content: html
                    });
                    google.maps.event.addListener(marker, "click", function () {
                        infowindow.open(map, marker);
                    });
                    google.maps.event.addDomListener(window, 'load', initialize);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });



        }

        function clearLocations() {
            for (var i = 0; i < markersCodeAddress.length; i++) {
                markersCodeAddress[i].setMap(null);
            }
            markersCodeAddress.length = 0;
        }
    </script>

     <!--END-->


    <script type="text/javascript">
        //<![CDATA[
        var map = null;
        var directionDisplay;
        var directionsService = new google.maps.DirectionsService();
        var j = 0;

        function initialize() {
            directionsDisplay = new google.maps.DirectionsRenderer(
                {
                    draggable: true

                });
            var mapOptions = {
                litemode: true,
                zoom: 7, //zoom level highest is 21 if m not wrong,
                mapTypeId: google.maps.MapTypeId.ROADMAP, //view type of the google map, ie either satellite, or road maps
                center: new google.maps.LatLng(30.850033, 76.6500523), //the longitute and latitude of the place which you want to put center in the map
            };
            map = new google.maps.Map(document.getElementById('map_canvas'), // defining div id to get the map
    mapOptions);


            directionsDisplay.setMap(map);

            directionsDisplay.addListener('directions_changed', function () {
                computeTotalDistance(directionsDisplay.getDirections());
            });

        }


        google.maps.event.addDomListener(window, "load", initialize);
        j = 1;
    </script>

    <script>
        var startLoc; var endLoc; var morePoints = [];

        $("#ddlStartLocationPOI").change(function () {
            debugger;
            var poiId = $('option:selected', this).val();
            startLoc = commonForStartEndPOI(poiId);
            AjaxGetVehicleNearestToPoint();

        });
  
 

        $("#ddlEndLocationPOI").change(function () {

            //$("#hidediv").css('display', 'block');
            //$("#hidediv2").css('display', 'block');

            $("#hidedivnew").css('display', 'block');
          

            

            var poiId = $('option:selected', this).val();
            endLoc = commonForStartEndPOI(poiId);
            if (!startLoc) {
                toastr.warning("Please select start location poi");
                return false;
            }
            getDirections();
        });

        $("#ddlMoreLocationsPOI").change(function () {
            debugger;
            var poiId = $("#ddlMoreLocationsPOI").val();
            var poiIdsList = poiId.toString();

            morePointsFun(poiIdsList);
            if (!startLoc || !endLoc) {
                toastr.warning("Please select start and end location poi");
                return false;
            }
            getDirections();
        });



        function commonForStartEndPOI(poiId) {
            var location;
            $.ajax({
                dataType: "json",
                type: "GET",
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                url: apiBase.apiurl + "MapAPI/GetPoiLatLongForAddTrip",
                data: { poiId: poiId },
                async: false,
                success: function (data) {
                    for (i = 0; i < data.length; i++) {
                        location = data[0].lat + ',' + data[0].lng;

                    }

                },
                error: function () {
                    alert('Please try again');
                }
            })
            return location;
        }

        function morePointsFun(poiIds) {
            debugger;
            morePoints = [];
            var location;
            $.ajax({
                dataType: "json",
                type: "GET",
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                url: apiBase.apiurl + "MapAPI/GetPoiLatLongForAddTrip",
                data: { poiId: poiIds },
                async: false,
                success: function (data) {
                    debugger;
                    for (i = 0; i < data.length; i++) {
                        location = data[i].lat + ',' + data[i].lng;
                        morePoints.push({
                            location: location,
                            stopover: true
                        });
                    }

                }
            })

        }


        function getDirections() {
            var request = {
                origin: startLoc,
                destination: endLoc,
                waypoints: morePoints,
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING
                //travelMode: google.maps.DirectionsTravelMode.DRIVING //defining the travel mode, so that you can have an estimation of time and best route
            };

            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                    debugger;
                    var route = response.routes[0];
                    var summaryPanel = document.getElementById('directions-panel');
                    var distanceValue = document.getElementById('txtManualDistance');
                    var ettValue = document.getElementById('txtETT');

                    var totalDistance = 0;
                    var totalTime = 0;

                    summaryPanel.innerHTML = '';
                    // For each route, display summary information.
                    for (var i = 0; i < route.legs.length; i++) {
                        debugger;
                        var routeSegment = i + 1;
                        summaryPanel.style.display = "block";
                        summaryPanel.innerHTML += '<b>' + routeSegment +
                            '</b><br>';
                        summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
                        summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
                        summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
                        debugger;
                        //getting total distance
                        totalDistance = totalDistance + parseFloat((route.legs[i].distance.value / 1000).toFixed(0));
                        //getting total estimated time
                        totalTime = totalTime + parseFloat((route.legs[0].duration.value / parseInt(60 * 60)).toFixed(0));
                      

                    }
                    distanceValue.value = totalDistance;
                    ettValue.value = totalTime;
                } else {
                    window.alert('Directions request failed due to ' + status);
                }


            });


            var ettValue = document.getElementById('txtETT');
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [startLoc],
                destinations: [endLoc],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {
                if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                    debugger;
                    var distance = response.rows[0].elements[0].distance.text;
                    var duration = response.rows[0].elements[0].duration.value;
                    var duration1 = response.rows[0].elements[0].duration.text;
                    var dvDistance = document.getElementById("dvDistance");
                 
                    $("#test1").html(duration1);
               
               
                } else {
                    alert("Unable to find the distance via road.");
                }
            });
        }



        function computeTotalDistance(result) {
            var total = 0;
            var duration = 0;
            var myroute = result.routes[0];
            for (var i = 0; i < myroute.legs.length; i++) {
                total += myroute.legs[i].distance.value;

            }
            total = total / 1000;


            document.getElementById('txtManualDistance').innerHTML = total + ' km';
        }
    </script>

    <!--for radius-->
    <script>
        var circle = null;
        var markers = [];
        var searchLatLng;
        function AjaxGetVehicleNearestToPoint() {
            debugger;
            //thi is used to clear markers
            deleteMarkers();
            // this is used to clear the table 
            // $("#vehTable tr").remove();
            if (circle != null) {
                circle.setMap(null);
            }

            //200 meter
            var Radius = parseInt((1000));

            debugger;
            var mySplitResult = startLoc.split(",");

            var lat = mySplitResult[0].toLowerCase().replace(/[\,\(\)\!\$]/g, '');
            var lng = mySplitResult[1].toLowerCase().replace(/[\,\(\)\!\$]/g, '');


            var myLatlng = new google.maps.LatLng(lat, lng);
            searchLatLng = myLatlng;
            map.setCenter(myLatlng);
            var infowindow = new google.maps.InfoWindow()

            var marker = new google.maps.Marker({
                map: map,
                position: myLatlng

            });



            circle = new google.maps.Circle({
                map: map,
                radius: Radius,    // 10 miles in metres
                fillColor: '#8e9d13'
            });
            circle.bindTo('center', marker, 'position');
            var vehicleType = $("#ddlVehicleType").val();
            //for returning all vehicles
            if (!vehicleType) {
                vehicleType = "0";
            }

            // $("#divLoader").removeClass("hidden");
            var url = apiBase.apiurl + "MapAPI/GetVehicleNearestToPoint";
            $.ajax({
                url: url,
                dataType: "json",
                type: "GET",
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',    //replace /json to the urlenoded
                data: { Lats: lat, Lngs: lng, DiameterInMeter: Radius, custId: $custid },                  // data is not json
                async: true,
                processData: true,                                                  //important to use it as true
                cache: false,

                success: function (data) {
                    debugger;
                    var count = 0;
                    //$("#divLoader").addClass("hidden");
                    $.each(data, function (i, variant) {
                        count += 1;
                        $('#lbltotalvehicle').html(count);

                        var myLatLng = new google.maps.LatLng(variant.Latitude, variant.Longitude);
                        plotMarker(myLatLng, map, variant.VehicleName, variant.Location, variant.LastDate, variant.VehcileStatus, variant.BBID, variant.IsDispatched, variant.Latitude, variant.Longitude, variant.icon)

                        //test
                        $("#hdnVehicleList").removeClass("hidden");

                    });

                    //   find_closest_marker(searchLatLng);
                },
                error: function (xhr) {
                    $("#divLoader").addClass("hidden");
                }
            });
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }

        //plot marker
        function plotMarker(position, map, name, Location, currentdate, VehStatus, bbid, IsDispatched, lat, lng, icon) {

            VehStatus = VehStatus.replace("~/", "../../");
            poiMarker = new google.maps.Marker({

                position: position,
                map: map,
                draggable: false,
                clickable: true,
                icon: VehStatus,
                animation: google.maps.Animation.DROP
            });
            var poimarker1 = poiMarker;
            markers.push(poiMarker);

            var contentString = '<b>Vehicle Name:</b>' + name + '<br/><b>Location:</b>' + Location + '<br/>' + '<b>Date: </b>' + currentdate + status;
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });
            google.maps.event.addDomListener(poimarker1, 'click', function () {
                infowindow.open(map, poimarker1);
            });
        }

        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

    </script>

    <style>
        #slide {
    height: 50px;
    transition:             height 500ms ease;
        -moz-transition:    height 500ms ease;
        -ms-transition:     height 500ms ease;
        -o-transition:      height 500ms ease;
        -webkit-transition: height 500ms ease;
}

        .primary-button {
    font-family: Arial, sans-serif;
    font-size: 1.3em;
    color: #fff;
    border: 1px solid #004487;
    background-image: -webkit-gradient(linear, top, bottom, from(#5288bd), to(#2f659a));
    background-image: -webkit-linear-gradient(top, #5288bd, #2f659a);
    box-shadow: inset 0px 1px 0px rgba(255, 255, 255, 0.4), inset 0px 0px 0px 1px rgba(255, 255, 255, 0.2), 0px 1px 0px rgba(255, 255, 255, .7);
     transform: rotate(90deg);
    text-shadow: 0px -1px 0px black;
    cursor: pointer;
    margin-top:170px;
}

.download-button {
    padding: 4px 20px;
    border-radius: 5px;
    display: block;
    width: 130px;
   margin: 32px auto -25px auto;
    margin-left: 345px;
}
    </style>
    <script>
        $("#imgclose").click(function () {
            //$("#hidedivnew").css('display', 'none');
            $("#hidedivnew").slideToggle();
            $("#btntrip").css('display', 'block');
            $("#btntripN").css('display', 'block');
        });


        $("#btntrip").click(function () {
            $("#hidedivnew").css('display', 'block');
            $("#btntrip").css('display', 'none');
        
        });

        $("#btnaddpoi").click(function () {
            $("#hidedivnewd").css('display', 'block');


        });
        $("#btntripN").click(function () {
            $("#hidedivnew").css('display', 'block');
          
            $("#btntripN").css('display', 'none');
        });
    </script>


     
}